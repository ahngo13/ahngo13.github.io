I"±;<h1 id="elastic-apmì´ë€">Elastic APMì´ë€?</h1>

<ul>
  <li>ì• í”Œë¦¬ì¼€ì´ì…˜ ëª¨ë‹ˆí„°ë§ì„ ìœ„í•´ ìƒì„¸í•œ ì„±ëŠ¥ ì§€í‘œë¥¼ ì œê³µ (ë¬¸ì œ í•´ê²° ì‹œê°„ì„ ìµœì†Œí™”í•´ì£¼ëŠ” ë„êµ¬)</li>
</ul>

<h2 id="elastic-apmì˜-ê¸°ëŠ¥">Elastic APMì˜ ê¸°ëŠ¥</h2>

<ul>
  <li>ì•±ê³¼ ì„œë¹„ìŠ¤ì˜ end to end í—¬ìŠ¤ ëª¨ë‹ˆí„°ë§</li>
  <li>ì´ìƒì¹˜ íƒì§€ì™€ ë¬¸ì œì  ì‹ë³„</li>
  <li>ë¬¸ì œì  ë¶„ë¥˜ ë° ê²©ë¦¬</li>
  <li>ê·¼ë³¸ ì›ì¸ ë¶„ì„ ë° ì‚¬ê³  ì—°ê²°</li>
  <li>ë¬¸ì œ ë””ë²„ê¹… ë° ì¤‘í™”</li>
</ul>

<h2 id="ìµœì†Œí•œì˜-ë…¸ë ¥ìœ¼ë¡œ-ì• í”Œë¦¬ì¼€ì´ì…˜-ì—°ê²°">ìµœì†Œí•œì˜ ë…¸ë ¥ìœ¼ë¡œ ì• í”Œë¦¬ì¼€ì´ì…˜ ì—°ê²°</h2>

<ul>
  <li>ì´ 7ê°œì˜ ì–¸ì–´ì™€ í”„ë ˆì„ì›Œí¬ ì œê³µ : í”„ë¡ íŠ¸ì—”ë“œì—ì„œ ë°±ì—”ë“œê¹Œì§€ ë°ì´í„° ìˆ˜ì§‘ ê°€ëŠ¥</li>
  <li>ê³µê°œ í‘œì¤€ ìˆ˜ìš© : OpenTracing, Jaeger, OpenTelemetryâ€¦</li>
  <li>ì½”ë“œ ìˆ˜ì¤€ ê°€ì‹œì„±</li>
  <li>ì—ì´ì „íŠ¸ ë¶€í•˜ ìµœì†Œí™”</li>
</ul>

<h2 id="ì• í”Œë¦¬ì¼€ì´ì…˜ê³¼-ì„œë¹„ìŠ¤ì˜-ì™„ì „í•œ-ê°€ì‹œì„±-í™•ë³´">ì• í”Œë¦¬ì¼€ì´ì…˜ê³¼ ì„œë¹„ìŠ¤ì˜ ì™„ì „í•œ ê°€ì‹œì„± í™•ë³´</h2>

<ul>
  <li>end to end ê°€ì‹œì„± : ë¶„ì‚° íŠ¸ë ˆì´ì‹±ìœ¼ë¡œ ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ í™˜ê²½ì—ì„œì˜ ë³‘ëª©ì§€ì  í™•ì¸</li>
  <li>ì˜ì¡´ì„± ë§¤í•‘ ìë™ ìƒì„± : ì˜ì¡´ì„±ì„ ìë™ìœ¼ë¡œ ê·¸ë ¤ì¤Œ</li>
  <li>í”„ë¡œì•¡í‹°ë¸Œ ê°€ìš©ì„± ëª¨ë‹ˆí„°ë§ : ì—…íƒ€ì„ê³¼ ì—°ë™</li>
</ul>

<h2 id="ìŠ¤ë§ˆíŠ¸-íƒì§€-ì‹ ì†í•œ-ê·¼ë³¸-ì›ì¸-ë¶„ì„">ìŠ¤ë§ˆíŠ¸ íƒì§€, ì‹ ì†í•œ ê·¼ë³¸ ì›ì¸ ë¶„ì„</h2>

<ul>
  <li>ìë™ ì´ìƒì¹˜ íƒì§€</li>
  <li>ê°•ë ¥í•œ ad hoc ê²€ìƒ‰</li>
  <li>ë‹¨ì¼í™”ëœ í†µí•© ê°€ì‹œì„± : logì™€ ë©”íŠ¸ë¦­ì»¨í…ìŠ¤íŠ¸ ë„˜ë‚˜ë“œëŠ” ì‹ ì†í•œ ê·¼ë³¸ ì›ì¸ ë¶„ì„</li>
</ul>

<h2 id="ê¸°ì¡´-ì›Œí¬í”Œë¡œìš°ì™€-í†µí•©">ê¸°ì¡´ ì›Œí¬í”Œë¡œìš°ì™€ í†µí•©</h2>

<ul>
  <li>ë°ë¸Œì˜µìŠ¤ ì½œë¼ë³´ : ë°°í¬ ì–´ë…¸í…Œì´ì…˜ì˜ ìƒí˜¸ ì—°ê²°</li>
  <li>ITSM í”„ë¡œì„¸ìŠ¤ ì—°ê²°</li>
</ul>

<h1 id="elasticsearch-apm-ì„¤ì¹˜">Elasticsearch APM ì„¤ì¹˜</h1>

<h2 id="docker-composeyml-íŒŒì¼-ì‘ì„±">docker-compose.yml íŒŒì¼ ì‘ì„±</h2>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">version</span><span class="pi">:</span> <span class="s1">'</span><span class="s">2.2'</span>
<span class="na">services</span><span class="pi">:</span>
  <span class="na">apm-server</span><span class="pi">:</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">docker.elastic.co/apm/apm-server:7.9.2</span>
    <span class="na">depends_on</span><span class="pi">:</span>
      <span class="na">elasticsearch</span><span class="pi">:</span>
        <span class="na">condition</span><span class="pi">:</span> <span class="s">service_healthy</span>
      <span class="na">kibana</span><span class="pi">:</span>
        <span class="na">condition</span><span class="pi">:</span> <span class="s">service_healthy</span>
    <span class="na">cap_add</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">CHOWN"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">DAC_OVERRIDE"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">SETGID"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">SETUID"</span><span class="pi">]</span>
    <span class="na">cap_drop</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">ALL"</span><span class="pi">]</span>
    <span class="na">ports</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">8200:8200</span>
    <span class="na">networks</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">elastic</span>
    <span class="na">command</span><span class="pi">:</span> <span class="pi">&gt;</span>
       <span class="s">apm-server -e</span>
         <span class="s">-E apm-server.rum.enabled=true</span>
         <span class="s">-E setup.kibana.host=kibana:5601</span>
         <span class="s">-E setup.template.settings.index.number_of_replicas=0</span>
         <span class="s">-E apm-server.kibana.enabled=true</span>
         <span class="s">-E apm-server.kibana.host=kibana:5601</span>
         <span class="s">-E output.elasticsearch.hosts=["elasticsearch:9200"]</span>
    <span class="na">healthcheck</span><span class="pi">:</span>
      <span class="na">interval</span><span class="pi">:</span> <span class="s">10s</span>
      <span class="na">retries</span><span class="pi">:</span> <span class="m">12</span>
      <span class="na">test</span><span class="pi">:</span> <span class="s">curl --write-out 'HTTP %{http_code}' --fail --silent --output /dev/null http://localhost:8200/</span>

  <span class="na">elasticsearch</span><span class="pi">:</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">docker.elastic.co/elasticsearch/elasticsearch:7.9.2</span>
    <span class="na">environment</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">bootstrap.memory_lock=true</span>
    <span class="pi">-</span> <span class="s">cluster.name=docker-cluster</span>
    <span class="pi">-</span> <span class="s">cluster.routing.allocation.disk.threshold_enabled=false</span>
    <span class="pi">-</span> <span class="s">discovery.type=single-node</span>
    <span class="pi">-</span> <span class="s">ES_JAVA_OPTS=-XX:UseAVX=2 -Xms1g -Xmx1g</span>
    <span class="na">ulimits</span><span class="pi">:</span>
      <span class="na">memlock</span><span class="pi">:</span>
        <span class="na">hard</span><span class="pi">:</span> <span class="s">-1</span>
        <span class="na">soft</span><span class="pi">:</span> <span class="s">-1</span>
    <span class="na">volumes</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">esdata:/usr/share/elasticsearch/data</span>
    <span class="na">ports</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">9200:9200</span>
    <span class="na">networks</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">elastic</span>
    <span class="na">healthcheck</span><span class="pi">:</span>
      <span class="na">interval</span><span class="pi">:</span> <span class="s">20s</span>
      <span class="na">retries</span><span class="pi">:</span> <span class="m">10</span>
      <span class="na">test</span><span class="pi">:</span> <span class="s">curl -s http://localhost:9200/_cluster/health | grep -vq '"status":"red"'</span>

  <span class="na">kibana</span><span class="pi">:</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">docker.elastic.co/kibana/kibana:7.9.2</span>
    <span class="na">depends_on</span><span class="pi">:</span>
      <span class="na">elasticsearch</span><span class="pi">:</span>
        <span class="na">condition</span><span class="pi">:</span> <span class="s">service_healthy</span>
    <span class="na">environment</span><span class="pi">:</span>
      <span class="na">ELASTICSEARCH_URL</span><span class="pi">:</span> <span class="s">http://elasticsearch:9200</span>
      <span class="na">ELASTICSEARCH_HOSTS</span><span class="pi">:</span> <span class="s">http://elasticsearch:9200</span>
    <span class="na">ports</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">5601:5601</span>
    <span class="na">networks</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">elastic</span>
    <span class="na">healthcheck</span><span class="pi">:</span>
      <span class="na">interval</span><span class="pi">:</span> <span class="s">10s</span>
      <span class="na">retries</span><span class="pi">:</span> <span class="m">20</span>
      <span class="na">test</span><span class="pi">:</span> <span class="s">curl --write-out 'HTTP %{http_code}' --fail --silent --output /dev/null http://localhost:5601/api/status</span>

<span class="na">volumes</span><span class="pi">:</span>
  <span class="na">esdata</span><span class="pi">:</span>
    <span class="na">driver</span><span class="pi">:</span> <span class="s">local</span>

<span class="na">networks</span><span class="pi">:</span>
  <span class="na">elastic</span><span class="pi">:</span>
    <span class="na">driver</span><span class="pi">:</span> <span class="s">bridge</span>
</code></pre></div></div>

<p><img src="/assets/img/2020-10-16_10h52_21.png" alt="/assets/img/2020-10-16_10h52_21.png" /></p>

<p><img src="/assets/img/2020-10-16_10h53_05.png" alt="/assets/img/2020-10-16_10h53_05.png" /></p>

<h2 id="apm-agents-ì—°ê²°">APM Agents ì—°ê²°</h2>

<h3 id="1-elastic-apm-agentjar-íŒŒì¼-download">1. elastic-apm-agent.jar íŒŒì¼ download</h3>

<p><a href="https://search.maven.org/search?q=a:elastic-apm-agent">https://search.maven.org/search?q=a:elastic-apm-agent</a></p>

<h3 id="2-demo-springboot-project-ìƒì„±">2. demo Springboot project ìƒì„±</h3>

<p><a href="https://start.spring.io/">https://start.spring.io/</a></p>

<ul>
  <li>í•„ìëŠ” ì•„ë˜ì™€ ê°™ì´ ë©”ì´ë¸ í”„ë¡œì íŠ¸ë¡œ í•´ë‹¹ Dependenciesë¥¼ ì¶”ê°€í•˜ì—¬ í”„ë¡œì íŠ¸ë¥¼ ìƒì„±í•˜ì˜€ë‹¤.</li>
</ul>

<p><img src="/assets/img/2020-10-16_13h27_55.png" alt="/assets/img/2020-10-16_13h27_55.png" /></p>

<ul>
  <li>ê°„ë‹¨í•œ html í˜ì´ì§€ë¥¼ ë„ìš°ê¸° ìœ„í•´ ì•„ë˜ì™€ ê°™ì´ <code class="language-plaintext highlighter-rouge">[DemoApplication.java](http://demoapplication.java)</code> íŒŒì¼ì„ ìˆ˜ì •í•œë‹¤.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>package com.example.demo<span class="p">;</span>

import org.springframework.boot.SpringApplication<span class="p">;</span>
import org.springframework.boot.autoconfigure.SpringBootApplication<span class="p">;</span>
import org.springframework.web.bind.annotation.GetMapping<span class="p">;</span>
import org.springframework.web.bind.annotation.RequestParam<span class="p">;</span>
import org.springframework.web.bind.annotation.RestController<span class="p">;</span>

@SpringBootApplication
@RestController
public class DemoApplication <span class="o">{</span>

	public static void main<span class="o">(</span>String[] args<span class="o">)</span> <span class="o">{</span>
		SpringApplication.run<span class="o">(</span>DemoApplication.class, args<span class="o">)</span><span class="p">;</span>
		System.out.println<span class="o">(</span><span class="s2">"Hello World"</span><span class="o">)</span><span class="p">;</span>
	<span class="o">}</span>

	@GetMapping<span class="o">(</span><span class="s2">"/hello"</span><span class="o">)</span>
	public String sayHello<span class="o">(</span>@RequestParam<span class="o">(</span>value <span class="o">=</span> <span class="s2">"myName"</span>, defaultValue <span class="o">=</span> <span class="s2">"World"</span><span class="o">)</span> String name<span class="o">)</span> <span class="o">{</span>
		<span class="k">return </span>String.format<span class="o">(</span><span class="s2">"Hello %s!"</span>, name<span class="o">)</span><span class="p">;</span>
	<span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<ul>
  <li>
    <p>Applicationì„ ì‹¤í–‰í•´ <a href="http://localhost:8080/hello">http://localhost:8080/hello</a> ë¡œ ì ‘ì†í•´ì„œ Hello World!ê°€ ì˜ ì°í˜€ë‚˜ì˜¤ëŠ”ì§€ í™•ì¸í•œë‹¤.</p>

    <p><img src="/assets/img/2020-10-16_13h31_26.png" alt="/assets/img/2020-10-16_13h31_26.png" /></p>
  </li>
  <li>
    <p>elastic-apm-agent.jarì„ ì›í•˜ëŠ” ìœ„ì¹˜ì— ì˜®ê²¨ ë†“ê³  ì¸í…”ë¦¬ì œì´ì—ì„œ <code class="language-plaintext highlighter-rouge">Ctrl+Alt+Shift+S</code> ë¡œ ì°½ì„ ë„ìš´ í›„ <code class="language-plaintext highlighter-rouge">Project Settings&gt;Modules&gt;Dependencies</code> ì— <code class="language-plaintext highlighter-rouge">+</code> ë²„íŠ¼ì„ ëˆŒëŸ¬ ë‹¤ìš´ë°›ì€ jaríŒŒì¼ì„ ì¶”ê°€ì‹œí‚¤ì.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>java <span class="nt">-javaagent</span>:/path/to/elastic-apm-agent-&lt;version&gt;.jar <span class="se">\</span>
     <span class="nt">-Delastic</span>.apm.service_name<span class="o">=</span>my-application <span class="se">\</span>
     <span class="nt">-Delastic</span>.apm.server_urls<span class="o">=</span>http://localhost:8200 <span class="se">\</span>
     <span class="nt">-Delastic</span>.apm.secret_token<span class="o">=</span> <span class="se">\</span>
     <span class="nt">-Delastic</span>.apm.application_packages<span class="o">=</span>org.example <span class="se">\</span>
     <span class="nt">-jar</span> my-application.jar
</code></pre></div></div>

<ul>
  <li>í”„ë¡œì íŠ¸ë¥¼ jaríŒŒì¼ë¡œ ë¬¶ì–´ì„œ ì‹¤í–‰í•  ê²ƒì´ë¼ë©´ ìœ„ì˜ ê³µì‹ë¬¸ì„œì— ë‚˜ì™€ìˆëŠ” ëŒ€ë¡œ í•„ìš”í•œ ë¶€ë¶„ë§Œ ìˆ˜ì •í•´ì„œ ì‚¬ìš©í•˜ë©´ ë˜ê³  IDEì—ì„œ ê·¸ëŒ€ë¡œ ì‹¤í–‰í•˜ê³  ì‹¶ë‹¤ë©´ í•„ìì²˜ëŸ¼ VM optionsì— ì•„ë˜ì™€ ë¹„ìŠ·í•˜ê²Œ ì‚¬ìš©í•˜ì—¬ ì‹¤í–‰í•˜ë©´ ëœë‹¤.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">-javaagent</span>:C:<span class="se">\/</span>elastic-apm-agent-1.18.1.jar <span class="nt">-Delastic</span>.apm.service_name<span class="o">=</span>demo <span class="nt">-Delastic</span>.apm.server_urls<span class="o">=</span>http://172.23.13.91:8200 <span class="nt">-Delastic</span>.apm.secret_token<span class="o">=</span> <span class="nt">-Delastic</span>.apm.application_packages<span class="o">=</span>com.example.demo
</code></pre></div></div>

<ul>
  <li>
    <p>ì˜¤ë¥˜ê°€ ë‚˜ì§€ ì•Šê³  ì •ìƒì ìœ¼ë¡œ ì‹¤í–‰ ë˜ì—ˆë‹¤ë©´ í‚¤ë°”ë‚˜ APM í˜ì´ì§€ë¡œ ëŒì•„ê°€ <code class="language-plaintext highlighter-rouge">Check agent status</code> ì™€ <code class="language-plaintext highlighter-rouge">Load Kibana objects</code> ë²„íŠ¼ì„ ëˆŒëŸ¬ ì„±ê³µì ìœ¼ë¡œ ì„¸íŒ…ì´ ë˜ì—ˆëŠ”ì§€ í™•ì¸í•œë‹¤.</p>

    <p><img src="/assets/img/2020-10-16_13h37_29.png" alt="/assets/img/2020-10-16_13h37_29.png" /></p>
  </li>
  <li>
    <p>ì„¸íŒ…ì´ ì˜ ë˜ì—ˆë‹¤ë©´ APMì„ ì‹¤í–‰í•œë‹¤.</p>
  </li>
</ul>

<h1 id="apm-ë°ì´í„°-í™•ì¸">APM ë°ì´í„° í™•ì¸</h1>

<h2 id="ì—°ë™ëœ-ì„œë¹„ìŠ¤-í™•ì¸">ì—°ë™ëœ ì„œë¹„ìŠ¤ í™•ì¸</h2>

<ul>
  <li>í•„ìê°€ ì—°ë™í•œ ì„œë¹„ìŠ¤ì¸ demoê°€ ì¶”ê°€ ë˜ì–´ìˆìŒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.</li>
</ul>

<p><img src="/assets/img/2020-10-16_13h46_16.png" alt="/assets/img/2020-10-16_13h46_16.png" /></p>

<h2 id="transactions-ëª¨ë‹ˆí„°ë§">Transactions ëª¨ë‹ˆí„°ë§</h2>

<ul>
  <li>í•„í„°ë¥¼ í†µí•´ì„œ ì›í•˜ëŠ” ì¡°ê±´ì„ ì£¼ì–´ íŠ¸ëœì­ì…˜ì— ëŒ€í•´ì„œ ëª¨ë‹ˆí„°ë§ì´ ê°€ëŠ¥</li>
</ul>

<p><img src="/assets/img/2020-10-16_13h50_30.png" alt="/assets/img/2020-10-16_13h50_30.png" /></p>

<p><img src="/assets/img/2020-10-16_13h52_29.png" alt="/assets/img/2020-10-16_13h52_29.png" /></p>

<h2 id="errors-ëª¨ë‹ˆí„°ë§">Errors ëª¨ë‹ˆí„°ë§</h2>

<ul>
  <li>í•„í„°ë¥¼ í†µí•´ì„œ ì›í•˜ëŠ” ì¡°ê±´ì„ ì£¼ì–´ íŠ¸ëœì­ì…˜ì— ëŒ€í•´ì„œ ëª¨ë‹ˆí„°ë§ì´ ê°€ëŠ¥</li>
</ul>

<p><img src="/assets/img/2020-10-16_14h01_38.png" alt="/assets/img/2020-10-16_14h01_38.png" /></p>

<h2 id="jvms-ëª¨ë‹ˆí„°ë§">JVMs ëª¨ë‹ˆí„°ë§</h2>

<ul>
  <li>í•„í„°ë¥¼ í†µí•´ì„œ ì›í•˜ëŠ” ì¡°ê±´ì„ ì£¼ì–´ íŠ¸ëœì­ì…˜ì— ëŒ€í•´ì„œ ëª¨ë‹ˆí„°ë§ì´ ê°€ëŠ¥</li>
</ul>

<p><img src="/assets/img/2020-10-16_14h02_25.png" alt="/assets/img/2020-10-16_14h02_25.png" /></p>
:ET